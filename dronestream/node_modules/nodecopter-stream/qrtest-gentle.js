#!/usr/bin/env node

'use strict';

var fs = require('fs')
  , util   = require('util')
  , Stream = require('stream').Stream
  , buffy  = require('buffy')
  , writeStream = fs.createWriteStream('out1')
  , readStream
  , parser
  ;

util.inherits(FileParser, Stream);

function FileParser() {
    var that = this;
    Stream.call(this);
    this.writable = true;
    this.readable = true;
    this._parser = buffy.createReader();
    setTimeout(function () {
        that.poll();
    }, 1);
}

FileParser.prototype.write = function (buffer) {
    var parser = this._parser;
    parser.write(buffer);
    return true;
};

FileParser.prototype.poll = function () {
    if (this._parser.bytesAhead() < 1000) {
        return;
    }
    this.emit('data', this._parser.buffer(1000));
}

FileParser.prototype.end = function (indata) {
    return this.emit('data', this._parser.buffer(this._parser.bytesAhead()));
    // nothing to do, just here so pipe() does not complain
};


parser = new FileParser();
parser.pipe(writeStream);
readStream = fs.createReadStream(process.argv[2]);
readStream.pause();
readStream.pipe(parser);
readStream.resume();

